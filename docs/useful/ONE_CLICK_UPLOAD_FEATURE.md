# 一鍵上傳功能實作說明

## 功能概述

「一鍵上傳」功能實現了從「備份」到「還原」的完整自動化閉環。當使用者在編輯視窗中選擇打包好的 `_packaged.json` 檔案時，系統會自動：

1. 解析 JSON 檔案中的所有文字資訊和 Base64 圖片資料
2. 將文字資訊填入表單對應欄位
3. 將 Base64 圖片轉換為 File 物件並上傳到伺服器
4. 動態建立圖片預覽
5. 完成商品資料的完整還原

## 核心功能模組

### 1. Base64 轉 File 轉換器
```javascript
function base64ToFile(base64String, filename = 'image.jpg')
```
- 移除 Base64 字串的 data URL 前綴
- 將 Base64 轉換為二進位資料
- 建立可上傳的 File 物件
- 支援自訂檔案名稱

### 2. 圖片上傳器
```javascript
async function uploadImage(file)
```
- 使用 FormData 封裝檔案資料
- 呼叫 `/api/Product/UploadFile` API
- 支援上傳進度追蹤
- 完整的錯誤處理機制

### 3. 圖片預覽建立器
```javascript
function createImagePreview(imagePath, filename)
```
- 動態建立圖片預覽元素
- 支援刪除功能
- 自適應圖片尺寸
- 美觀的 UI 設計

### 4. 批量上傳處理器
```javascript
async function uploadImagesFromPackagedJson(photos)
```
- 逐張處理圖片（避免伺服器壓力）
- 自動建立預覽
- 進度追蹤和狀態回饋
- 錯誤恢復機制

## 工作流程

### 步驟 1：JSON 解析
1. 讀取打包的 JSON 檔案
2. 檢測是否包含 Base64 圖片資料
3. 提取所有文字資訊和圖片資料

### 步驟 2：表單填充
1. 將文字資訊填入對應欄位
2. 處理下拉選單和特殊欄位
3. 自動設定拍賣期間

### 步驟 3：圖片處理
1. 遍歷 Photos 陣列中的每張圖片
2. 將 Base64 轉換為 File 物件
3. 逐張上傳到伺服器
4. 接收伺服器回應的圖片路徑

### 步驟 4：預覽建立
1. 根據伺服器回應建立圖片預覽
2. 動態添加到上傳區域
3. 綁定刪除功能

### 步驟 5：完成回饋
1. 顯示上傳完成通知
2. 記錄上傳統計資訊
3. 清理臨時資源

## 技術特點

### 非同步處理
- 使用 async/await 確保操作順序
- 支援並行處理多個任務
- 避免阻塞使用者介面

### 錯誤處理
- 單張圖片失敗不影響其他圖片
- 詳細的錯誤日誌記錄
- 友善的錯誤提示訊息

### 效能優化
- 逐張上傳避免伺服器壓力
- 上傳間隔控制（500ms）
- 進度追蹤和狀態回饋

### 使用者體驗
- 即時上傳進度顯示
- 動態預覽建立
- 完成通知提示

## API 整合

### 上傳端點
- **URL**: `https://recycledstuff.ntpc.gov.tw/BidMgr/api/Product/UploadFile`
- **方法**: POST
- **格式**: multipart/form-data
- **欄位**: `file` (檔案資料)

### 回應格式
```json
{
  "FilePath": "/uploads/image_123.jpg",
  "FileName": "image_123.jpg",
  "FileSize": 102400
}
```

## 使用方式

### 1. 準備打包檔案
- 使用「打包下載」功能下載 `_packaged.json` 檔案
- 確保檔案包含完整的商品資訊和 Base64 圖片

### 2. 開啟編輯視窗
- 點擊「新增」按鈕開啟編輯視窗
- 確認表單正常載入

### 3. 執行一鍵上傳
- 點擊「匯入 JSON」按鈕
- 選擇打包好的 `_packaged.json` 檔案
- 等待系統自動處理

### 4. 驗證結果
- 檢查文字資訊是否正確填入
- 確認圖片預覽是否正常顯示
- 驗證所有欄位資料完整性

## 錯誤處理

### 常見問題
1. **圖片上傳失敗**
   - 檢查網路連線
   - 確認檔案格式正確
   - 查看伺服器回應

2. **預覽建立失敗**
   - 檢查上傳區域是否存在
   - 確認圖片路徑正確
   - 驗證 DOM 操作權限

3. **JSON 解析錯誤**
   - 確認檔案格式正確
   - 檢查 Base64 資料完整性
   - 驗證檔案編碼

### 除錯指令
```javascript
// 檢查上傳區域
console.log('上傳區域:', document.querySelector('.el-upload__list'));

// 檢查圖片預覽
console.log('圖片預覽:', document.querySelectorAll('.el-upload-list__item'));

// 檢查上傳進度
console.log('上傳狀態:', window.uploadStatus);
```

## 注意事項

1. **檔案大小限制**
   - 單張圖片建議不超過 5MB
   - 總上傳量建議不超過 50MB

2. **網路連線**
   - 確保網路連線穩定
   - 避免同時上傳大量檔案

3. **瀏覽器相容性**
   - 支援現代瀏覽器
   - 需要 JavaScript 啟用

4. **伺服器限制**
   - 遵守伺服器上傳限制
   - 避免過於頻繁的請求

## 未來擴展

1. **批量處理**
   - 支援多個 JSON 檔案同時處理
   - 批次上傳優化

2. **進度顯示**
   - 更詳細的上傳進度條
   - 實時狀態更新

3. **錯誤恢復**
   - 自動重試機制
   - 斷點續傳功能

4. **預覽優化**
   - 圖片縮放功能
   - 拖拽排序功能 